<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Cloud.gov documentation">
    <meta name="author" content="18f">
    <meta name="generator" content="Hugo 0.14" />

    <title>Creating a local dev environment with Virtual Box</title>

    <link href="/css/bootstrap-theme.css" rel="stylesheet">
    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/style-responsive.css" rel="stylesheet" />
    <link href="/css/monokai_sublime.css" rel="stylesheet" />

  </head>

  <body>
  
  <section id="container" class="">

      
      <header class="header black-bg">
            <div class="toggle-nav">
                <i class="fa fa-bars"></i>
                <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"></div>
            </div>

            
            <a href="/" title="Home">
              <h2 class="main">docs.cloud.gov</h2>
            </a>
            
            <div class="top-nav notification-row">
            </div>

            <div class="nav title-row" id="top_menu">
                <h1 class="nav top-menu">Creating a local dev environment with Virtual Box</h1>
            </div>
      </header>
      


<aside>
    <div id="sidebar" class="nav-collapse">
        
        <ul class="sidebar-menu">
          
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-road'></i>
                
                <span>Getting Started</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/getting-started/setup/">Setup</a> </li>
                    
                    <li><a href="/getting-started/concepts/">Concepts</a> </li>
                    
                    <li><a href="/getting-started/cf-ssh/">Running one off tasks</a> </li>
                    
                </ul>
              
              </li>
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-file-text'></i>
                
                <span>Deploying Apps</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/apps/deployment/">General Deployment Tips</a> </li>
                    
                    <li><a href="/apps/basic-deploy-troubleshooting/">Basic Deploy Troubleshooting</a> </li>
                    
                    <li><a href="/apps/cloning/">Cloning Applications</a> </li>
                    
                    <li><a href="/apps/continuous-deployment/">Continuous Deployment</a> </li>
                    
                    <li><a href="/apps/databases/">Databases</a> </li>
                    
                    <li><a href="/apps/django/">Deploying Django</a> </li>
                    
                    <li><a href="/apps/flask/">Deploying Flask</a> </li>
                    
                    <li><a href="/apps/meteor/">Deploying Meteor</a> </li>
                    
                    <li><a href="/apps/multi-buildpack-deploys/">Deploying Multi-language Projects</a> </li>
                    
                    <li><a href="/apps/rails/">Deploying Rails</a> </li>
                    
                    <li><a href="/apps/static/">Deploying Static Sites</a> </li>
                    
                    <li><a href="/apps/node/">Deploying node.js</a> </li>
                    
                    <li><a href="/apps/durable-logging/">Durable Logging with the ELK Service</a> </li>
                    
                    <li><a href="/apps/moving-apps/">Moving apps between spaces</a> </li>
                    
                    <li><a href="/apps/production-ready/">Production Ready Checklist</a> </li>
                    
                    <li><a href="/apps/apt-get/">Using apt-get</a> </li>
                    
                </ul>
              
              </li>
          
              

            <li class="sub-menu active">
            <a href="javascript:;" class="">
                <i class='fa fa-wrench'></i>
                
                <span>Operations</span>
                <span class="menu-arrow fa fa-angle-down"></span>
            </a>
                <ul class="sub open">
                    
                    <li><a href="/ops/aws-onboarding/">AWS Onboarding</a> </li>
                    
                    <li><a href="/ops/accessing-v1-managed-services/">Accessing v1 Managed Services</a> </li>
                    
                    <li><a href="/ops/changing-password/">Changing a password</a> </li>
                    
                    <li><a href="/ops/creating-a-stemcell-building-vm/">Creating a Stemcell Building VM</a> </li>
                    
                    <li><a href="/ops/creating-a-development-environment-with-bosh-lite/">Creating a dev environment</a> </li>
                    
                    <li class="active"><a href="/ops/creating-a-local-dev-environment-in-Virtual-Box/">Creating a local dev environment with Virtual Box</a> </li>
                    
                    <li><a href="/ops/create-user/">Creating a user</a> </li>
                    
                    <li><a href="/ops/creating-a-new-admin-user/">Creating an admin user</a> </li>
                    
                    <li><a href="/ops/deploying-the-docker-broker/">Deploying the Docker Broker</a> </li>
                    
                    <li><a href="/ops/deploying-the-admin-ui/">Deploying the admin UI</a> </li>
                    
                    <li><a href="/ops/elb/">ELB termination</a> </li>
                    
                    <li><a href="/ops/repos/">Github Repos</a> </li>
                    
                    <li><a href="/ops/making-announcements/">Making announcements</a> </li>
                    
                    <li><a href="/ops/metrics/">Metrics</a> </li>
                    
                    <li><a href="/ops/plugins/">Plugins</a> </li>
                    
                    <li><a href="/ops/policies/">Policies</a> </li>
                    
                    <li><a href="/ops/ports/">Port Descriptions</a> </li>
                    
                    <li><a href="/ops/multiple-instances/">Running Multiple Instances</a> </li>
                    
                    <li><a href="/ops/updating-cf/">Updating Cloud Foundry</a> </li>
                    
                </ul>
              
              </li>
          
              
              </li>
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-columns'></i>
                
                <span>Updates</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/updates/2015-05-29/">5/29/2015</a> </li>
                    
                </ul>
              
              </li>
          
            <li> <a href="https://github.com/18f/cloud-foundry-notes/issues" target="blank"><i class='fa fa-life-ring'></i> <span>Issues & Help</span></a> </li>
            
              <li><a href="https://github.com/18f/cloud-foundry-notes/edit/master/content/ops/creating-a-local-dev-environment-in-Virtual-Box.md" target="blank"><i class='fa fa-edit'></i> Refine this Page</a> </li>
            
        </ul>
        
    </div>
</aside>



      
      <section id="main-content">
          <section class="wrapper">

              <div class="row">
                  <div class="col-md-1">
                      
                      
                      
                  </div>
                <div class="col-md-10">
                    <section class="panel">
                      <div class="panel-body">



<p>BOSH Lite is designed to provide a local development environment for BOSH and by extension Cloud Foundry. BOSH Lite will be used run locally via Virtualbox. This guide is primarily concerned with bringing up a single-instance environment VB.</p>

<h3 id="prerequisites:d316bf5ca3b159279bf1726ee89ea21d">Prerequisites:</h3>

<ol>
<li><a href="#vagrant:d316bf5ca3b159279bf1726ee89ea21d">Vagrant</a></li>
<li><a href="#virtual-box:d316bf5ca3b159279bf1726ee89ea21d">Virtual Box</a></li>
<li><a href="#docker:d316bf5ca3b159279bf1726ee89ea21d">Docker</a></li>
<li><a href="#git:d316bf5ca3b159279bf1726ee89ea21d">Git</a></li>
<li><a href="#cloud-foundry-cli:d316bf5ca3b159279bf1726ee89ea21d">Cloud Foundry CLI</a></li>
</ol>

<h5 id="vagrant:d316bf5ca3b159279bf1726ee89ea21d">Vagrant</h5>

<p>The bosh-lite repo provides a Vagrantfile and VM for quickly standing up a bosh lite director on VBox.</p>

<pre><code>brew cask install vagrant
vagrant plugin install vagrant-berkshelf
vagrant plugin install vagrant-omnibus
</code></pre>

<p>Note: If that fails goto <a href="http://www.vagrantup.com/downloads">http://www.vagrantup.com/downloads</a> and install from web</p>

<h5 id="virtual-box:d316bf5ca3b159279bf1726ee89ea21d">Virtual Box</h5>

<p>While not strictly necessary, but this guide assumes a recent version is installed. Install or update it from:</p>

<pre><code>brew cask install virtualbox
</code></pre>

<p>Additional info can be found here: <a href="https://www.virtualbox.org/wiki/Downloads">https://www.virtualbox.org/wiki/Downloads</a></p>

<h5 id="docker:d316bf5ca3b159279bf1726ee89ea21d">Docker</h5>

<p>We need to install Docker. It will be used to build the cflinuxfs2.tar.gz. Install from here:</p>

<pre><code>brew cask install dockertoolbox
</code></pre>

<p>Additional info can be found here: <a href="https://docs.docker.com/mac/step_one/">https://docs.docker.com/mac/step_one/</a></p>

<h5 id="git:d316bf5ca3b159279bf1726ee89ea21d">Git</h5>

<p>Needed to clone the bosh-lite repo.</p>

<pre><code>brew install git
</code></pre>

<h5 id="cloud-foundry-cli:d316bf5ca3b159279bf1726ee89ea21d">Cloud Foundry CLI</h5>

<p>The <code>cf</code> command is our gateway to the Cloud Foundry environment, it handles everything from the creation of users and organizations to pushing and scaling applications.</p>

<pre><code>brew tap pivotal/tap
brew install cloudfoundry-cli
</code></pre>

<h3 id="procedure:d316bf5ca3b159279bf1726ee89ea21d">Procedure:</h3>

<h5 id="prepare-vagrant:d316bf5ca3b159279bf1726ee89ea21d">Prepare Vagrant</h5>

<p>Grab the bosh-lite repo.</p>

<pre><code>git clone https://github.com/cloudfoundry/bosh-lite.git
cd bosh-lite
gem install nokogiri -- --with-xml2-include=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.9.sdk/usr/include/libxml2
gem install bosh_cli
</code></pre>

<p>Add the bosh-lite vagrant box.</p>

<pre><code>vagrant box add cloudfoundry/bosh-lite
</code></pre>

<p>Choose option 2 for Virtualbox.</p>

<h5 id="launch-vagrant:d316bf5ca3b159279bf1726ee89ea21d">Launch Vagrant</h5>

<p>Bring the vagrant machine up.</p>

<pre><code>vagrant up
</code></pre>

<p>The initial <code>vagrant up</code> includes provisioning scripts which set up port forwarding rules via iptables to expose Cloud Foundry service VMs running as warden containers on the instance.  If the machine is restarted or halted for any reason weâ€™ll need to follow the steps in <a href="#reprovisioning:d316bf5ca3b159279bf1726ee89ea21d">reprovisioning</a> below.</p>

<h5 id="finish-building-the-virtualbox-instance:d316bf5ca3b159279bf1726ee89ea21d">Finish Building the Virtualbox Instance:</h5>

<p>Connect to the VBox instance via SSH.</p>

<pre><code>vagrant ssh
</code></pre>

<p>There are a few utilities that we&rsquo;ll need to configure the Cloud Foundry environment which aren&rsquo;t included with the BOSH Lite public AMI.</p>

<pre><code>sudo apt-get update &amp;&amp; sudo apt-get -y install git unzip
</code></pre>

<p>Add the spiff utility.</p>

<pre><code>wget https://github.com/cloudfoundry-incubator/spiff/releases/download/v1.0.3/spiff_linux_amd64.zip
sudo unzip spiff_linux_amd64.zip -d /usr/local/bin
</code></pre>

<p>Create a workspace directory.</p>

<pre><code>mkdir workspace
cd workspace
</code></pre>

<p>Target the local bosh director.</p>

<pre><code>bosh target 127.0.0.1
</code></pre>

<p>Clone the bosh bosh-lite and cf-release repository.</p>

<pre><code>git clone https://github.com/cloudfoundry/bosh-lite.git
git clone https://github.com/cloudfoundry/cf-release.git
mkdir -p ~/workspace/cf-release/blobs/rootfs    #needed for later step with docker
cd bosh-lite
</code></pre>

<h5 id="configure-cloud-foundry:d316bf5ca3b159279bf1726ee89ea21d">Configure Cloud Foundry:</h5>

<p>With VirtualBox the domain will be tied to the localhost and will always be:
    &hellip;
    domain: api.bosh-lite.com
    &hellip;</p>

<h5 id="provision-cloud-foundry:d316bf5ca3b159279bf1726ee89ea21d">Provision Cloud Foundry:</h5>

<p>Add some dependency packages for the provisioning tool</p>

<pre><code>sudo apt-get install ruby
sudo gem install bundle
sudo apt-get install curl
</code></pre>

<p>Run the automated provisioning script.</p>

<pre><code>sudo ./bin/provision_cf
</code></pre>

<p>This script automates the process of:</p>

<ol>
<li>Uploading the latest release to the director.</li>
<li>Uploading a public stemcell (latest-bosh-stemcell-warden.tgz) to the director.</li>
<li>Generating a deployment manifest from the included templates.</li>
<li>Deploying the generated manifest to a set of warden containers inside the instance.</li>
</ol>

<p>This process takes about 15-20 minutes.</p>

<p>When complete, use bosh vms to have a look at the resulting environment.</p>

<pre><code>ubuntu@agent-id-bosh-0:~/workspace/bosh-lite$ bosh vms

Deployment `cf-warden'

Director task #

Task # done

+------------------------------------+---------+---------------+--------------+
| Job/index                          | State   | Resource Pool | IPs          |
+------------------------------------+---------+---------------+--------------+
| api_z1/0                           | running | large_z1      | 10.244.0.138 |
| etcd_z1/0                          | running | medium_z1     | 10.244.0.42  |
| ha_proxy_z1/0                      | running | router_z1     | 10.244.0.34  |
| hm9000_z1/0                        | running | medium_z1     | 10.244.0.142 |
| loggregator_trafficcontroller_z1/0 | running | small_z1      | 10.244.0.150 |
| loggregator_z1/0                   | running | medium_z1     | 10.244.0.146 |
| login_z1/0                         | running | medium_z1     | 10.244.0.134 |
| nats_z1/0                          | running | medium_z1     | 10.244.0.6   |
| postgres_z1/0                      | running | medium_z1     | 10.244.0.30  |
| router_z1/0                        | running | router_z1     | 10.244.0.22  |
| runner_z1/0                        | running | runner_z1     | 10.244.0.26  |
| uaa_z1/0                           | running | medium_z1     | 10.244.0.130 |
+------------------------------------+---------+---------------+--------------+

VMs total: 12
</code></pre>

<p>We&rsquo;re done provisioning, now we&rsquo;ll disconnect and access the environment via the Cloud Foundry CLI.</p>

<pre><code>ubuntu@agent-id-bosh-0:exit             #exit Vagrant SSH
~/host_working_folder/bosh-lite/bin/add-route
</code></pre>

<h4 id="create-and-copy-a-blob-into-the-vagrant-image:d316bf5ca3b159279bf1726ee89ea21d">Create and copy a blob into the vagrant image</h4>

<pre><code>vagrant plugin install vagrant-scp
cd ~/host_working_folder/
</code></pre>

<p>Now Docker must be installed and running on your Mac for the next procedure to work. Launch into a docker terminal to create the cflinuxfs2 container.</p>

<pre><code>git clone https://github.com/cloudfoundry/stacks.git
cd stacks
make
</code></pre>

<p>Secure copy the cflinuxfs2 container to the CF VM.</p>

<pre><code>cd ../bosh-lite
vagrant scp ~/host_working_folder/stacks/cflinuxfs2.tar.gz default:/home/vagrant/workspace/cf-release/blobs/rootfs
</code></pre>

<h4 id="initial-cloud-foundry-configuration:d316bf5ca3b159279bf1726ee89ea21d">Initial Cloud Foundry Configuration:</h4>

<p>Connect using the Cloud Foundry CLI.</p>

<pre><code>cf api --skip-ssl-validation https://api.bosh-lite.com
cf auth admin admin
</code></pre>

<p><strong>Note:</strong> This step will fail with a 500 error if the VMs cannot reach each other via <code>https://api.bosh-lite.com</code>.</p>

<p>Verify deployment</p>

<pre><code>Create and target an organization.

    cf create-org MY-ORGANIZATION
    cf target -o MY-ORGANIZATION

Create and target a space.

    cf create-space MY-SPACE
    cf target -s MY-SPACE
</code></pre>

<h5 id="reprovisioning:d316bf5ca3b159279bf1726ee89ea21d">Reprovisioning:</h5>

<p>If the Vagrant machine is halted or restarted for any reason there are  several steps we&rsquo;ll need to take to recreate the environment.</p>

<p>1.) Recreate forwarding rules.</p>

<pre><code>vagrant up
vagrant provision
</code></pre>

<p>2.) Repair the VMs.</p>

<pre><code>bosh cck cf-warden
$BOSH-LITE-WORKING-DIRECTORY/bin/add-route
</code></pre>

<p>Choose option 2 &ldquo;Recreate VM&rdquo; for each VM (M of N) then confirm the choices. A new director task will be created to recreate each VM in turn. This will take several minutes to complete. Use &gt;bosh vms to have a look at the resulting environment.</p>

<pre><code>bosh vms        # verify that service is up
~/&lt;host_working_folder&gt;/bosh-lite/bin/add-route
</code></pre>

<p>Original steps found here: <a href="https://github.com/cloudfoundry/bosh-lite">https://github.com/cloudfoundry/bosh-lite</a></p>

<p>Original Cloud Foundry installation with BOSH details are here if BOSH-LITE ./scripts/provision_cf script is not used: <a href="http://docs.cloudfoundry.org/deploying/boshlite/deploy_cf_boshlite.html">http://docs.cloudfoundry.org/deploying/boshlite/deploy_cf_boshlite.html</a></p>

                      <hr style="margin: 2em auto 0.25em;">
                    </div>
                    </section>

                    <footer>
                      Built with <i class="fa fa-heart"></i> by the cloud.gov team | 
                      <a href="https://github.com/18F/cloud-foundry-notes/issues">
                        Send us feedback
                      </a>
                    </footer>

                </div>
                <div class="col-md-1">
                    
                    
                    
                </div>
              </div>
              
          </section>
      </section>
     
  </section>
  
    
    <script src="/js/jquery-2.1.1.min.js"></script>
    <script src="/js/jquery.scrollTo.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/scripts.js"></script>
  <script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

