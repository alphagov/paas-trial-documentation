<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Govt PaaS documentation">
    <meta name="author" content="Brett Ansley">
    <meta name="generator" content="Hugo 0.14" />

    <title>Durable Logging with the ELK Service</title>

    <link href="/css/bootstrap-theme.css" rel="stylesheet">
    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/style-responsive.css" rel="stylesheet" />
    <link href="/css/monokai_sublime.css" rel="stylesheet" />

  </head>

  <body>
  
  <section id="container" class="">

      
      <header class="header black-bg">
            <div class="toggle-nav">
                <i class="fa fa-bars"></i>
                <div class="icon-reorder tooltips" data-original-title="Toggle Navigation" data-placement="bottom"></div>
            </div>

            
            <a href="/" title="Home">
              <h2 class="main">Govt PaaS</h2>
            </a>
            
            <div class="top-nav notification-row">
            </div>

            <div class="nav title-row" id="top_menu">
                <h1 class="nav top-menu">Durable Logging with the ELK Service</h1>
            </div>
      </header>
      


<aside>
    <div id="sidebar" class="nav-collapse">
        
        <ul class="sidebar-menu">
          
          
              

            <li class="sub-menu">
            <a href="javascript:;" class="">
                <i class='fa fa-road'></i>
                
                <span>Getting Started</span>
                <span class="menu-arrow fa fa-angle-right"></span>
            </a>
                <ul class="sub">
                    
                    <li><a href="/getting-started/setup/">Setup</a> </li>
                    
                    <li><a href="/getting-started/concepts/">Concepts</a> </li>
                    
                    <li><a href="/getting-started/cf-ssh/">Running one off tasks</a> </li>
                    
                </ul>
              
              </li>
          
              

            <li class="sub-menu active">
            <a href="javascript:;" class="">
                <i class='fa fa-file-text'></i>
                
                <span>Deploying Apps</span>
                <span class="menu-arrow fa fa-angle-down"></span>
            </a>
                <ul class="sub open">
                    
                    <li><a href="/apps/deployment/">General Deployment Tips</a> </li>
                    
                    <li><a href="/apps/quotas/">Quotas</a> </li>
                    
                    <li><a href="/apps/sample-apps/">Sample apps</a> </li>
                    
                    <li><a href="/apps/basic-deploy-troubleshooting/">Basic Deploy Troubleshooting</a> </li>
                    
                    <li><a href="/apps/cloning/">Cloning Applications</a> </li>
                    
                    <li><a href="/apps/continuous-deployment/">Continuous Deployment</a> </li>
                    
                    <li><a href="/apps/databases/">Databases</a> </li>
                    
                    <li><a href="/apps/django/">Deploying Django</a> </li>
                    
                    <li><a href="/apps/flask/">Deploying Flask</a> </li>
                    
                    <li><a href="/apps/multi-buildpack-deploys/">Deploying Multi-language Projects</a> </li>
                    
                    <li><a href="/apps/static/">Deploying Static Sites</a> </li>
                    
                    <li><a href="/apps/node/">Deploying node.js</a> </li>
                    
                    <li class="active"><a href="/apps/durable-logging/">Durable Logging with the ELK Service</a> </li>
                    
                    <li><a href="/apps/moving-apps/">Moving apps between spaces</a> </li>
                    
                    <li><a href="/apps/production-ready/">Production Ready Checklist</a> </li>
                    
                    <li><a href="/apps/apt-get/">Using apt-get</a> </li>
                    
                </ul>
              
              </li>
          
            <li> <a href="mailto:support@governmentpaas.zendesk.com" target="blank"><i class='fa fa-life-ring'></i> <span>Issues & Help</span></a> </li>
        </ul>
        
    </div>
</aside>



      
      <section id="main-content">
          <section class="wrapper">

              <div class="row">
                  <div class="col-md-1">
                      
                      
                      
                  </div>
                <div class="col-md-10">
                    <section class="panel">
                      <div class="panel-body">



<p>The ELK service provides Elasticsearch, Logstash and Kibana in a single service offering. By binding an instance of the service to your applications logs will be drained to a Logstash syslog receiver and stored in Elasticsearch with Kibana as the interface for search and visualization.</p>

<h3 id="usage:a916e664b719c16cfca614b66a52d60a">Usage</h3>

<p>Getting the most out of the ELK service requires several steps.</p>

<h4 id="basics:a916e664b719c16cfca614b66a52d60a">Basics</h4>

<ul>
<li><a href="#create-the-service">Create the service</a></li>
<li><a href="#bind-the-service">Bind the service</a></li>
<li><a href="#make-it-permanent">Make it permanent</a></li>
</ul>

<h4 id="kibana-access:a916e664b719c16cfca614b66a52d60a">Kibana Access</h4>

<ul>
<li><a href="#create-a-kibana-proxy">Create a Kibana proxy</a></li>
<li><a href="#access-kibana-for-the-first-time">Access Kibana for the first time</a></li>
</ul>

<h4 id="advanced-access:a916e664b719c16cfca614b66a52d60a">Advanced Access</h4>

<ul>
<li><a href="#create-an-elasticsearch-marvel-proxy">Create an Elasticsearch / Marvel proxy</a></li>
</ul>

<h3 id="basics-1:a916e664b719c16cfca614b66a52d60a">Basics</h3>

<h5 id="create-the-service:a916e664b719c16cfca614b66a52d60a">Create the service</h5>

<p>Ensure that the service is offered in your orangization.</p>

<pre><code class="language-bash">cf marketplace
</code></pre>

<p><strong>output</strong></p>

<pre><code class="language-bash">Getting services from marketplace in org ORG / space SPACE as USER...
OK

service        plans        description
ELK            free         Elasticsearch, Logstash and Kibana
</code></pre>

<p>Create an ELK instance.</p>

<pre><code class="language-bash">cf cs elk free MY_ELK
</code></pre>

<h5 id="bind-the-service:a916e664b719c16cfca614b66a52d60a">Bind the service</h5>

<p>Bind the ELK instance to your applications.</p>

<pre><code class="language-bash">cf bs APPNAME MY_ELK
</code></pre>

<p>Application logs will begin draining to the ELK instance shortly, you do not need to restage the newly bound applications.</p>

<h5 id="make-it-permanent:a916e664b719c16cfca614b66a52d60a">Make it permanent</h5>

<p>Add the ELK binding to your application manifest as shown below to ensure ELK is re-bound whenever your app is recreated.</p>

<p><strong>manifest.yml</strong></p>

<pre><code class="language-yml">---
  ...
  services:
    - MY_ELK
</code></pre>

<h3 id="kibana-access-1:a916e664b719c16cfca614b66a52d60a">Kibana Access</h3>

<h4 id="create-a-kibana-proxy:a916e664b719c16cfca614b66a52d60a">Create a Kibana proxy</h4>

<p>Access to Kibana requires the creation of a service proxy. Use <a href="https://github.com/18F/cf-service-proxy/blob/master/make-proxy.sh">make-proxy</a> to do this.</p>

<p>Clone the <a href="git@github.com:18F/cf-service-proxy.git">cf-service-proxy</a> repo.</p>

<pre><code class="language-bash">git clone git@github.com:18F/cf-service-proxy.git
cd cf-service-proxy
</code></pre>

<p>Create Staticfile.auth to provide a username and password for use with the Kibana proxy.</p>

<pre><code class="language-bash">openssl rand -base64 32 | tee htpasswd -ic nginx-auth/Staticfile.auth USERNAME
</code></pre>

<p>The generated password will echo to the console, make note of it.</p>

<pre><code class="language-bash">./make-proxy.sh -p \
  -s MY_ELK \
  -n MY_ELK-kibana \
  -d DOMAIN \
  -g &quot;./nginx-auth&quot;
</code></pre>

<p>Note: <code>DOMAIN</code> should only include the domain portion of your Kibana proxy route without the hostname. You can list available domains with <code>cf domains</code>.</p>

<p><strong>output</strong></p>

<pre><code>Looking for jq.
  - Found jq.
Getting domains for ed.
Getting status for MY_ELK.
  - Checking service bindings for MY_ELK.
    - Found bindings.
Checking status for MY_ELK-proxy.
Creating MY_ELK-proxy...

Getting service credentials for MY_ELK.
  Port: 12345
  IP: 10.10.10.1

Getting app environment for MY_ELK-proxy.
! Proxy vars don't match.
+ Injecting service credentials into MY_ELK-proxy.
  + Binding MY_ELK-proxy to PROXY_HOST in 10.10.10.1
  + Binding MY_ELK-proxy to PROXY_PORT in 12345.
Checking status for MY_ELK-proxy.
- Finishing start of MY_ELK-proxy.
  - Getting credentials for MY_ELK-proxy.
Checking status for MY_ELK-proxy.

Access the the proxied service here:

https://user:pass@proxy.domain
Done.
</code></pre>

<p>Now your ELK service instance is accessible through an nginx service proxy using basic authentication. Be sure to record the generated password.</p>

<h4 id="access-kibana-for-the-first-time:a916e664b719c16cfca614b66a52d60a">Access Kibana for the first time.</h4>

<p>Launch a browser and head to the provided URL, logging in with the provided username and password.</p>

<p>Kibana requires a few moments to load.</p>

<p><img src="/img/kibana_loading-450.png" alt="Selecting an index pattern is the first step in accessing a new Kibana instance." title="Selecting an index pattern." /></p>

<p>Proceed with the default index name and pattern. This can always be changed later via the &lsquo;Settings&rsquo; link at the top of each Kibana view.</p>

<p>For more information on these settings see <a href="https://www.elastic.co/guide/en/kibana/current/setup.html">Getting Kibana Up and Running</a> in the official docs.</p>

<p><img src="/img/configure_index_pattern-450.png" alt="Selecting an index pattern is the first step in accessing a new Kibana instance." /></p>

<p>Click &lsquo;Create&rsquo; to proceed.</p>

<p><img src="/img/logstash-450.png" alt="Creating the index." /></p>

<p>Click &lsquo;Discover&rsquo; to head to the search view.</p>

<p><img src="/img/links-450.png" alt="Click Discover to reach the search view." /></p>

<p>Enter a search filter and press Enter to being reviewing your logs.</p>

<p><img src="/img/search-450.png" alt="Enter a search filter." /></p>

<h3 id="kibana-access-2:a916e664b719c16cfca614b66a52d60a">Kibana Access</h3>

<h4 id="create-an-elasticsearch-marvel-proxy:a916e664b719c16cfca614b66a52d60a">Create an Elasticsearch / Marvel Proxy</h4>

<p>Creating the Elasticsearch / Marvel proxy follows much the same process as the Kibana proxy with two differences.</p>

<ol>
<li><p>Elasticsearch in the ELK service container uses the <a href="https://github.com/Asquera/elasticsearch-http-basic">http-basic</a> plugin for authentication in place of nginx.</p></li>

<li><p>By default the <code>make-proxy</code> script uses proxies the first service port, 5601 for Kibana. The service container also exposes 9200 and 9300 for Elasticsearch http and transport respectively as well as 5000 to recieve syslog messages.</p>

<p>This proxy will connect the Elasticsearch http port by specifying <code>&quot;9200/tcp&quot;</code> with the <code>-z</code> switch.</p></li>
</ol>

<pre><code>./make-proxy.sh \
  -s MY_ELK \
  -d DOMAIN \
  -z &quot;9200/tcp&quot; \
  -p
</code></pre>

<p><strong>output</strong></p>

<pre><code>Looking for jq.
  - Found jq.
Getting status for MY_ELK.
  - Checking service bindings for MY_ELK.
Creating temp app: placeholder-7D45FC20-2A19-48C8-BCC6-3DECA5530DFB
Binding service to temp app: placeholder-7D45FC20-2A19-48C8-BCC6-3DECA5530DFB
  - Checking service bindings for MY_ELK.
Deleting: placeholder-7D45FC20-2A19-48C8-BCC6-3DECA5530DFB
Cleaning up: /tmp/placeholder-7D45FC20-2A19-48C8-BCC6-3DECA5530DFB
Checking status for MY_ELK-proxy.
Creating MY_ELK-proxy...

Getting service credentials for MY_ELK.
  Port: 12345
  IP: 10.10.10.1

Getting app environment for MY_ELK-proxy.
! Proxy vars don't match.
+ Injecting service credentials into MY_ELK-proxy.
  + Binding MY_ELK-proxy to PROXY_HOST in 10.10.10.1.
  + Binding MY_ELK-proxy to PROXY_PORT in 12345.
Checking status for MY_ELK-proxy.
- Finishing start of MY_ELK-proxy.
  - Getting credentials for MY_ELK-proxy.
Checking status for MY_ELK-proxy.

Access the the proxied service here:

https://user:password@proxy.domain
Done.
</code></pre>

                      <hr style="margin: 2em auto 0.25em;">
                    </div>
                    </section>

                    <footer>
                      Built by the Government PaaS team | 
                      <a href="mailto:support@governmentpaas.zendesk.com">
                        Send us feedback
                      </a>
                    </footer>

                </div>
                <div class="col-md-1">
                    
                    
                    
                </div>
              </div>
              
          </section>
      </section>
     
  </section>
  
    
    <script src="/js/jquery-2.1.1.min.js"></script>
    <script src="/js/jquery.scrollTo.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/scripts.js"></script>
  <script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

